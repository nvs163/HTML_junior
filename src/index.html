<!DOCTYPE html>
<html lang="ru">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Сравнение открытых OLAP-систем Big Data: ClickHouse, Druid и Pinot</title>
</head>

<body>
   <div>
      <h1>Сравнение открытых OLAP-систем Big Data: ClickHouse, Druid и Pinot</h1>
   </div>

   <div>
      <p>
         <a href="https://clickhouse.yandex/">ClickHouse</a>, <a href="http://druid.io/">Druid</a> и <a
            href="https://github.com/linkedin/pinot">Pinot</a> – три открытых хранилища данных, которые позволяют
         выполнять аналитические запросы на больших объемах данных с интерактивными задержками. Эта статья - перевод <a
            href="https://medium.com/@leventov/comparison-of-the-open-source-olap-systems-for-big-data-clickhouse-druid-and-pinot-8e042a5ed1c7">подробного
            сравнения</a>, выполненного Романом Левентовым.
      </p>
   </div>

   <div>
      <h3>Источники информации</h3>
   </div>

   <div>
      <p>
         Подробности реализации <b>ClickHouse</b> стали мне известны от <a href="https://github.com/ztlpn">Алексея
            Зателепина</a>, одного из <b>ключевых разработчиков проекта</b>. Доступная на английском документация
         достаточно скудна – наилучшим источником информации служат последние четыре секции данной страницы
         документации.
      </p>

      <p>
         <b>Я сам участвую в развитии Druid</b>, но у меня нет личной заинтересованности в этой системе - по правде
         говоря, скорее всего в ближайшее время я перестану заниматься её разработкой. Поэтому читатели могут
         рассчитывать на отсутствие какой-либо предвзятости.
      </p>

      <p>
         Всё, что я буду далее писать про <b>Pinot</b>, основывается на странице <a
            href="https://github.com/linkedin/pinot/wiki/Architecture">Архитектура в вики Pinot</a>, а также на других
         страницах вики в разделе “Проектная документация”. Последний раз они обновлялись в июне 2017 года - больше, чем
         полгода назад.
      </p>

      <p>
         Рецензентами оригинальной статьи стали Алексей Зателепин и <a href="https://github.com/ludv1x">Виталий
            Людвиченко</a> (разработчики ClickHouse), <a href="https://github.com/gianm">Жан Мерлино</a> (самый активный
         разработчик Druid), <a href="https://github.com/kishoreg">Кишор Гопалакришна</a> (архитектор Pinot) и <a
            href="https://github.com/jfim">Жан-Француа Им</a> (разработчик Pinot). Мы присоединяемся к благодарности
         автора и полагаем, что это многократно повышает авторитетность статьи.
      </p>

      <p>
         <b>Предупреждение</b>: статья достаточно большая, поэтому вполне возможно вы захотите ограничиться прочтением
         раздела “Заключение” в конце.
      </p>
   </div>

   <div>
      <h2>Сходства между системами</h2>
   </div>

   <div>
      <h3>Связанные данные и вычисления</h3>
   </div>

   <div>
      <p>
         <b>На фундаментальном уровне, ClickHouse, Druid и Pinot похожи,</b> поскольку они хранят данные и выполняют
         обработку запросов на одних и тех же узлах, уходя от “разъединенной” архитектуры BigQuery. Недавно я уже
         описывал несколько наследственных проблем со связанной архитектурой в случае Druid [<a
            href="https://medium.com/@leventov/the-problems-with-druid-at-large-scale-and-high-load-part-1-714d475e84c9">1</a>,
         <a
            href="https://medium.com/@leventov/the-challenges-of-running-druid-at-large-scale-and-future-directions-part-2-ef594ce298f2">2</a>].
         Открытого эквивалента для BigQuery на данный момент не существует (за исключением, разве что, <a
            href="http://drill.apache.org/">Drill</a>?) Возможным подходам к построению подобных открытых систем
         посвящена <a
            href="https://medium.com/@leventov/design-of-a-cost-efficient-time-series-store-for-big-data-88c5dc41af8e">другая
            статье в моем блоге</a>.
      </p>
   </div>

   <div>
      <h3>Отличия от Big Data SQL-систем: индексы и статическое распределение данных</h3>
   </div>

   <div>
      <p>
         Рассматриваемые в этой статье системы <b>выполняют запросы быстрее</b>, чем системы Big Data из семейства
         класса SQL-on-Hadoop: Hive, Impala, Presto и Spark, даже когда последние получают доступ к данным, хранящимся в
         колоночном формате - к примеру, Parquet или Kudu. Это происходит потому, что в ClickHouse, Druid и Pinot:
      </p>
   </div>

   <div>
      <ul>
         <li>Имеется <b>свой собственный формат для хранения данных с индексами</b>, и они тесно интегрированы с
            движками обработки запросов. Системы класса SQL-on-Hadoop обычно можно назвать агностиками относительно
            форматов данных и поэтому они менее “навязчивы” в бэкендах Big Data.</li>
         <li><b>Данные распределены относительно “статично”</b> между узлами, и при распределенном выполнении запроса
            это можно использовать. Обратная сторона медали при этом в том, что ClickHouse, Druid и Pinot <b>не
               поддерживают запросы, которые требуют перемещения большого количества данных</b> между узлами - к
            примеру, join между двумя большими таблицами.</li>
      </ul>
   </div>

   <div>
      <h3>Отсутствие точечных обновлений и удалений</h3>
   </div>

   <div>
      <p>
         Находясь на другой стороне спектра баз данных, ClickHouse, Druid и Pinot <b>не поддерживают точечные обновления
            и удаления</b>, в противоположность колоночным системам вроде Kudu, InfluxDB и Vertica (?). Это даёт
         ClickHouse, Druid и Pinot возможность производить более эффективное колоночное сжатие и более агрессивные
         индексы, что означает <b>большую эффективность использования ресурсов</b> и быстрое выполнение запросов.
      </p>

      <p>
         Разработчики ClickHouse в Yandex планируют начать поддерживать <a
            href="https://clickhouse.yandex/docs/en/roadmap.html#q1-2018">обновления и удаления в будущем</a>, но я не
         уверен, будут ли это “настоящие” точечные запросы или обновления/удаления диапазонов данных.
      </p>
   </div>

   <div>
      <h3>Поглощение в стиле Big Data</h3>
   </div>

   <div>
      <p>
         Все три системы поддерживают потоковое поглощение данных из Kafka. Druid и Pinot поддерживают потоковую
         передачу данных стриминг в <a href="https://en.wikipedia.org/wiki/Lambda_architecture">Лямбда-стиле</a> и
         пакетное поглощение одних и тех же данных. ClickHouse поддерживает пакетные вставки напрямую, поэтому ему не
         требуется отдельная система пакетного поглощения подобная той, что используется в Druid и Pinot. Если вас
         интересуют подробности, то их вы сможете найти далее.
      </p>
   </div>

   <div>
      <h3>Проверено на крупном масштабе</h3>
   </div>

   <div>
      <p>
         Все три системы проверены на работоспособность в крупных масштабах: в <a
            href="https://yandex.com/blog/clickhouse/evolution-of-data-structures-in-yandex-metrica">Yandex.Metrica
            работает кластер ClickHouse</a>, состоящий из примерно десятка тысяч ядер CPU. В Metamarkets используется <a
            href="https://medium.com/@leventov/the-problems-with-druid-at-large-scale-and-high-load-part-1-714d475e84c9">кластер
            Druid аналогичного размера</a>. Один кластер Pinot в LinkedIn включает в себя “<a
            href="https://github.com/linkedin/pinot/issues/3#issuecomment-228497765">тысячи машин</a>”.
      </p>
   </div>

   <div>
      <h3>Незрелость</h3>
   </div>

   <div>
      <p>
         Все рассматриваемые в статье системы являются <b>незрелыми по меркам открытых enterprise-систем Big Data</b>.
         Однако, скорее всего они незрелы не более, чем среднестатистическая открытая система Big Data - но это совсем
         другая история. В ClickHouse, Druid и Pinot недостает некоторых очевидных оптимизаций и функциональности, и они
         кишат багами (насчет ClickHouse и Pinot я не уверен на все 100%, но не вижу причин, по которым они в этом плане
         были бы лучше Druid).
      </p>

      <p>Это плавно подводит нас к следующему важному разделу.</p>
   </div>

   <div>
      <h2>Про сравнение производительности и выбор системы</h2>
   </div>

   <div>
      <p>
         Я регулярно вижу в сети, как некоторые проводят сравнения систем больших данных: они берут набор своих данных,
         каким-либо образом “скармливают” его оцениваемой системе, а затем немедленно пытаются измерить
         производительность - сколько памяти или дискового пространства было занято, и насколько быстро выполнялись
         запросы. Причем понимание того, как устроены изнутри испытываемые ими системы, у них отсутствует. Затем,
         используя лишь подобные специфичные данные о производительности - иногда вместе со списками функциональности,
         которая им нужна и которая есть в системе <i>на настоящий момент</i>, - они в итоге делают свой выбор или, что
         еще хуже, выбирают написать свою собственную, “лучшую” систему с нуля.
      </p>

      <p>Такой подход мне кажется неправильным, по крайней мере он неприменим в отношении открытых OLAP-систем для Big
         Data. Задача создания системы Bid Data OLAP, которая смогла бы работать эффективно в большинстве сценариев
         использования и содержала бы все необходимые функции настолько велика, что я оцениваю ее реализацию как минимум
         в <b>100 человеко-лет</b>.</p>

      <p>На сегодня, ClickHouse, Druid и Pinot оптимизированы <i>только</i> для конкретных сценариев использования,
         которые требуются их разработчиком - и содержат по большей части лишь те функции, в которых нуждаются сами
         разработчики. Я могу гарантировать, что ваш случай обязательно “упрется” в те узкие места, с которыми
         разработчики рассматриваемых OLAP-систем еще не сталкивались - или же в те места, что их не интересуют.</p>

      <p>Не говоря уже о том, что упомянутый выше подход “забросить данные в систему, о которой вы ничего не знаете, и
         затем измерить её эффективность” весьма вероятно даст искаженный результат из-за серьезных “узких” мест,
         которые на самом деле могли бы быть исправлены <b>простым изменением конфигурации</b>, схемы данных или другим
         построением запроса.</p>
   </div>

   <div>
      <h3>CloudFlare: ClickHouse против Druid</h3>
   </div>

   <div>
      <p>
         Одним таким примером, хорошо иллюстрирующим описанную выше проблему, является пост Марека Вавруша о <a
            href="https://blog.cloudflare.com/how-cloudflare-analyzes-1m-dns-queries-per-second/#comment-3302778860">выборе
            между ClickHouse и Druid в Cloudflare</a>. Им потребовалось 4 сервера ClickHouse (которые со временем
         превратились в 9), и по их оценкам, для разворачивания аналогичной установки Druid им бы потребовались “сотни
         узлов”. Пусть Марек и признает, что <b>сравнение является нечестным</b>, поскольку Druid недостаёт “сортировки
         по первичному ключу”, он возможно даже не осознает, что достичь примерно того же самого эффекта в Druid
         возможно просто <a href="http://druid.io/docs/0.11.0/ingestion/index.html">установив правильный порядок
            измерений в “ingestion spec”</a> и произведя простую подготовку данных: обрезать значение колонки __time в
         Druid до некоей грубой детализации (к примеру, один час) и опционально добавить другую “длинно-типовую” колонку
         “precise_time”, если для некоторых запросов требуются более точные временные рамки. Да, это хак, но, как мы
         только что выяснили, и в Druid можно сортировать данные по какому-либо измерению перед __time, и это достаточно
         просто реализовать.
      </p>

      <p>
         Впрочем, я не стану спорить с их итоговым решением выбрать ClickHouse, поскольку на масштабе примерно в 10
         узлов и для их нужд ClickHouse мне тоже кажется лучшим выбором, чем Druid. Но сделанное ими заключение о том,
         что ClickHouse как минимум на порядок эффективнее (по меркам стоимости инфраструктуры), чем Druid - это
         серьезное заблуждение. На самом деле, из рассматриваемых нами сегодня систем, <b>Druid предлагает наилучшую
            возможность для реально дешевых установок</b> (смотрите раздел “Уровни узлов обработки запросов в Druid ”
         ниже).
      </p>
   </div>

   <div>
      <blockquote>
         <p>
            <mark>
               Когда вы выбираете систему OLAP Big Data, не сравнивайте то, насколько они сейчас хорошо подходят для
               вашего случая. Сейчас они все субоптимальны. Вместо этого, сравните, насколько быстро ваша компания
               способна заставить двигаться эти системы в том направлении, которое нужно именно вам.
            </mark>
         </p>
      </blockquote>
   </div>

   <div>
      <p>
         В силу своей фундаментальной архитектурной схожести, ClickHouse, Druid и Pinot имеют примерно один и тот же
         “предел” эффективности и оптимизации производительности. Здесь нет “волшебной таблетки”, которая позволила бы
         какой-либо из этих систем быть быстрее, чем остальные. Не позволяйте запутать себя тем фактом, что <i>в своем
            текущем состоянии</i> системы показывают себя очень по-разному в различных бенчмарках.
      </p>

      <p>
         Допустим, Druid не поддерживает “сортировку по первичному ключу” настолько хорошо, насколько это умеет
         ClickHouse - а ClickHouse в свою очередь не поддерживает “инвертированные индексы” столь же хорошо, как Druid,
         что дает данным системам преимущества с той или иной нагрузкой. <b>Упущенные оптимизации могут быть реализованы
            в выбранной системе при помощи не таких уж и больших усилий</b>, если у вас есть намерение и возможность
         решиться на подобный шаг.
      </p>
   </div>

   <div>
      <ul>
         <li>
            В вашей организации должны быть инженеры, способные прочитать, понять и модифицировать исходный код
            выбранной системы, к тому же у них должно быть на это время. Заметьте, что ClickHouse написан на C++, а
            Druid и Pinot —  на Java.
         </li>
         <li>
            Или же ваша организация должна подписать контракт с компанией, которая оказывает поддержку выбранной
            системы. Это будут <a href="https://www.altinity.com/">Altinity</a> для ClickHouse, <a
               href="https://imply.io/services">Imply</a> и <a
               href="https://hortonworks.com/open-source/druid/">Hortonworks</a> для Druid. Для Pinot таких компаний в
            данный момент нет.
         </li>
      </ul>
   </div>

   <div>
      <p>
         Другие сведения о разработке систем, которые вам стоит принять во внимание:
      </p>
   </div>

   <div>
      <ul>
         <li>
            Авторы ClickHouse, работающие в Yandex, утверждают, что они тратят 50% своего времени на создание
            функциональности, которая требуется им внутри компании, и другие 50% уходят на функции, который набирают
            большинство “голосов сообщества”. Однако, чтобы вы получили от этого факта преимущество, требуется, чтобы
            <b>функции, которые нужны вам, были и наиболее востребованы сообществом</b> ClickHouse.
         </li>
         <li>
            Разработчики Druid из Imply мотивированы работать над широко используемыми функциями, поскольку это позволит
            им максимально увеличить объем охвата своего бизнеса в будущем.
         </li>
         <li>
            Процесс разработки Druid сильно напоминает <a
               href="https://community.apache.org/apache-way/apache-project-maturity-model.html">модель Apache</a>,
            когда ПО несколько лет разрабатывается несколькими компаниями, у каждой из который достаточно своеобразные и
            различные приоритеты, и среди них нет ведущей компании. ClickHouse и Pinot пока еще далеки от подобного
            этапа, поскольку ими занимаются соответственно лишь Yandex и Linkedin. Сторонний вклад в развитие Druid
            имеет минимальный шанс быть отклоненным в силу того, что он расходится с видением основного разработчика -
            ведь <b>в Druid нет “основной” компании-разработчика.</b>
         </li>
         <li>
            Druid поддерживает “API разработчика”, который позволяет привносить собственные типы колонок, механизмы
            агрегации, возможные варианты для «глубокого хранения» и пр., причем все это вы можете держать в кодовой
            базе, отдельной от самого ядра Druid. Данное API документировано разработчиками Druid, и они следят за его
            совместимостью с предыдущими версиями. Однако, оно недостаточно “взрослое”, и ломается практически с каждым
            новым релизом Druid. Насколько мне известно, в ClickHouse и Pinot схожие API не поддерживаются.
         </li>
         <li>
            Согласно Github, <b>над Pinot работает наибольшее число людей</b> - по всей видимости, лишь за прошлый год в
            Pinot было вложено <a
               href="https://github.com/linkedin/pinot/graphs/contributors?from=2017-01-24&to=2018-01-24&type=c">не
               менее 10 человеко-лет</a>. Для ClickHouse эта цифра составляет примерно 6 человеко-лет, а для Druid - 7.
            В теории, это <u>должно</u> означать, что Pinot улучшается быстрее всех остальных систем, которые мы
            рассматриваем.
         </li>
      </ul>
   </div>

   <div>
      <h3>Управление данными: сравнение</h3>
   </div>

   <div>
      <p>
         Подход к управлению данными в ClickHouse проще, чем в Druid и Pinot: не требуется “глубокого хранилища”, всего
         один тип узлов, не требуется выделенного сервера для управления данными. Но подход ClickHouse приводит к
         некоторым трудностям, когда любая таблица данных вырастает настолько большой, что требуется ее разбиение между
         десятком или более узлов: коэффициент усиления запроса становится настолько же велик, насколько и фактор
         секционирования - даже для запросов, которые покрывают небольшой интервал данных:
      </p>
   </div>

   <figure>
      <!--Здесь нужен тег div для блока или нет?-->
      <img src="img/or.png" alt="Segmented" width="600">
      <figcaption>Компромисс распределения данных в ClickHouse</figcaption>
   </figure>

   <div>
      <p>
         В примере, показанном на изображении выше, данные таблицы распределены между тремя узлами в Druid/Pinot, но
         запрос по малому интервалу данных обычно затрагивает лишь два из них (до той поры, пока интервал не пересечет
         пограничный интервал сегмента). В ClickHouse, любые запросы будут вынуждены затронуть три узлв – если таблица
         сегментирована между тремя узлами. В данном примере разница не выглядит настолько существенно, однако
         представьте себе, что случится, если число узлов достигнет 100 – в то время как фактор сегментирования
         по-прежнему может быть равен, например, 10 в Druid/Pinot.
      </p>
   </div>

   <div>
      <h3>Уровни узлов обработки запросов в Druid</h3>
   </div>

   <div>
      <p>
         Управление данными при помощи сегментов «проще себе представить» - эта концепция хорошо ложится на наши
         когнитивные способности. Сами сегменты можно перемещать между узлами относительно просто. Эта две причины
         позволили Druid реализовать <b><i>“разделение на уровни”</i></b> узлов, занимающихся обработкой запросов:
         старые данные автоматически перемещаются на сервера с относительно большими дисками, но меньшим количеством
         памяти и CPU, что позволяет <b>значительно снизить стоимость большого рабочего кластера Druid</b> за счет
         замедления запросов к более старым данным. Эта функция позволяет Metamarkets экономить сотни тысяч долларов
         расходов на инфраструктуру Druid каждый месяц - в противовес тому варианту, если бы использовался “плоский”
         кластер.
      </p>
   </div>

   <figure>
      <img src="img/druid.png" alt="Druid">
      <figcaption><i>Уровни узлов обработки запросов в Druid</i></figcaption>
   </figure>

   <div>
      <p>
         Насколько мне известно, в ClickHouse и Pinot пока еще нет похожей функциональности - предполагается, что все
         узлы в их кластерах одинаковы.
      </p>
   </div>

   <div>
      <h3>ClickHouse vs. Druid или Pinot: Выводы</h3>
   </div>

   <table border="1">
      <!--Здесь нужен тег div для блока или нет?-->
      <tr>
         <th>ClickHouse</th>
         <th>Druid или Pinot</th>
      </tr>
      <tr>
         <td>В организации есть эксперты по C++</td>
         <td>В организации есть эксперты по Java</td>
      </tr>
      <tr>
         <td>Малый кластер</td>
         <td>Большой кластер</td>
      </tr>
      <tr>
         <td>Немного таблиц</td>
         <td>Много таблиц</td>
      </tr>
      <tr>
         <td>Один набор данных</td>
         <td>Несколько несвязанных наборов данных</td>
      </tr>
      <tr>
         <td>Таблицы и данные находятся в кластере перманентно</td>
         <td>Таблицы и наборы данных периодически появляются в кластере и удаляются из него</td>
      </tr>
      <tr>
         <td>Размер таблиц (и интенсивность запросов к ним) остается стабильным во времени</td>
         <td>Таблицы значительно растут и сжимаются</td>
      </tr>
      <tr>
         <td>Однородные запросы (их тип, размер, распределение по времени суток и т.д.)</td>
         <td>Разнородные запросы</td>
      </tr>
      <tr>
         <td>В данных есть измерение, по которому оно может быть сегментировано, и почти не выполняется запросов,
            которые затрагивают данные, расположенные в нескольких сегментах</td>
         <td>Подобного измерения нет, и запросы часто затрагивают данные, расположенные во всем кластере</td>
      </tr>
      <tr>
         <td>Облако не используется, кластер должен быть развернут на специфическую конфигурацию физических серверов
         </td>
         <td>Кластер развернут в облаке</td>
      </tr>
      <tr>
         <td>Нет существующих кластеров Hadoop или Spark</td>
         <td>Кластеры Hadoop или Spark уже существуют и могут быть использованы</td>
      </tr>
   </table>

   <div>
      <p>
         <b>Примечание:</b> ни одно из свойств выше не означает, что вы должны использовать соответствующую систему
         (системы), или избегать другую. К примеру, если планируется, что ваш кластер будет большим, это не значит, что
         вы обязательно должны рассматривать только Druid или Pinot, исключив ClickHouse. Скорее всего, в данной
         ситуации Druid или Pinot могут быть лучшим выбором, но другие полезные свойства могут перевесить чашу весов в
         сторону ClickHouse, который для некоторых приложений является оптимальным выбором даже для больших кластеров.
      </p>
   </div>

   <div>
      <h2>Заключение</h2>
   </div>

   <div>
      <p>
         ClickHouse, Druid и Pinot имеют фундаментально схожую архитектуру, и занимают свою собственную нишу между Big
         Data-фреймворками общего назначения вроде Impala, Presto, Spark, и колоночными базами данных с корректной
         поддержкой первичных ключей, точечных обновлений и удалений, как InfluxDB.
      </p>

      <p>
         В силу схожести архитектур, ClickHouse, Druid и Pinot имеют примерно одинаковый “предел оптимизации”. Но в
         своем текущем состоянии, все три системы еще незрелы и очень далеки от этого лимита. Существенных улучшений в
         производительности данных систем (применительно к специфическим сценариям использования) можно достичь
         несколькими человеко-месяцами работы опытных инженеров.
      </p>
   </div>

   <div>
      <blockquote>
         <mark>
            Я бы не рекомендовал вам сравнивать производительность данных систем между собой - выберите для себя ту,
            чей исходный код вы способны понять и модифицировать, или ту, в которую вы хотите инвестировать свои
            ресурсы.
         </mark>
      </blockquote>
   </div>

   <div>
      <p>
         Единственным долгосрочным различием между Druid и Pinot является то, что Pinot зависит от фреймворка Helix и
         будет продолжать зависеть от ZooKeeper, в то время как Druid может уйти от зависимости от ZooKeeper. С другой
         стороны, установка Druid продолжит зависеть от наличия какой-либо SQL-базы данных. На данный момент, Pinot
         оптимизирован лучше, чем Druid.
      </p>
   </div>

   <div>
      <blockquote>
         <mark>
            Если вы уже сталкивались с необходимостью сравнения этих систем и сделали свой выбор, то приходите на
            одну из наших конференций и расскажите о своем кейсе: о том какие именно были задачи и какие грабли (а
            наверняка они были) вы встретили. Хотя, конечно, базы данных далеко не единственная тема. Ближайший по
            окончанию срока подачи заявок (до 9 апреля) фестиваль РИТ++ включает направления: фронтенд, бэкенд,
            эксплуатацию и управление. Участникам обычно интереснее всего узнать о конкретных примерах, но и выступления
            и в виде обзоров и исследований тоже возможны – главное, чтобы тема была интересна лично вам.
         </mark>
      </blockquote>
   </div>
</body>

</html>